<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2A9D8F" />
  <meta name="description" content="Professional invoice and estimate manager with offline support" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="OMC Invoice" />
  <title>OMC Invoice Manager • Offline First</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" type="image/png" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Neutral color scheme: greys, greens, orange highlights */
    html, body {
      height: 100%;
      background: #f5f5f5; /* Light grey background */
      color: #2d2d2d; /* Dark grey/black text */
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .panel {
      background: #ffffff; /* White panels */
      border: 1px solid #d4d4d4; /* Medium grey border */
      border-radius: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Subtle shadow */
    }
    .field {
      background:#ffffff;
      border:1px solid #c4c4c4;
      border-radius:8px;
      padding:.55rem .7rem;
      width:100%;
      color:#2d2d2d;
    }
    .field:focus {
      outline: none;
      border-color: #2A9D8F; /* Green focus */
    }
    .muted { color:#737373; /* Medium grey for muted text */ }
    .toolbar { background:#e8e8e8; border-top:1px solid #d4d4d4; }
    .tab-btn {
      padding:.6rem 1rem;
      border-radius:.6rem;
      border:1px solid #c4c4c4;
      background:#ffffff;
      color:#2d2d2d;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      background:#f9f9f9;
      border-color:#2A9D8F;
    }
    .tab-btn.active {
      background:#2A9D8F; /* Green active state */
      border-color:#2A9D8F;
      color:white;
    }
    .gridish { display:grid; grid-template-columns: repeat(12, 1fr); gap: .75rem; }
    .btn {
      background:#2A9D8F; /* Primary green */
      color:white;
      padding:.55rem .9rem;
      border-radius:.6rem;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover {
      background:#238b7e; /* Darker green on hover */
    }
    .btn.outline {
      background:transparent;
      border:1px solid #c4c4c4;
      color:#2d2d2d;
    }
    .btn.outline:hover {
      background:#f9f9f9;
      border-color:#2A9D8F;
    }
    .btn.red {
      background:#e74c3c; /* Softer red */
    }
    .btn.red:hover {
      background:#c0392b;
    }
    .btn.orange {
      background:#F4A261; /* Orange highlight */
      color: white;
    }
    .btn.orange:hover {
      background:#e8935a;
    }
    .list {
      border:1px solid #d4d4d4;
      border-radius:.8rem;
      overflow:hidden;
      background: white;
    }
    .list thead th {
      background: #e8e8e8;
      border-bottom:1px solid #d4d4d4;
      padding:.55rem .6rem;
      font-weight: 600;
      color: #2d2d2d;
    }
    .list td {
      border-bottom:1px solid #efefef;
      padding:.55rem .6rem;
    }
    .list tbody tr:hover {
      background: #fafafa;
    }
    .pill {
      border:1px solid #c4c4c4;
      background:#f5f5f5;
      border-radius:999px;
      padding:.2rem .6rem;
      font-size:.75rem;
      color: #555;
    }
    @media print {
      body { background:white; color:black; }
      .no-print { display:none !important; }
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="mx-auto max-w-6xl p-4 sm:p-6">
    <!-- HEADER -->
    <header class="flex items-center justify-between mb-4">
      <div>
        <div class="text-xs uppercase tracking-wide muted">Current estimate</div>
        <div class="text-xl font-semibold" id="hdrEstimateName">New estimate</div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <select id="projectSelect" class="field w-56" onchange="projectSwitch(this.value)"></select>
        <button class="btn" onclick="projectNew()">New project</button>
        <button class="btn outline" onclick="projectDuplicate()">Duplicate</button>
        <button class="btn red" onclick="projectDelete()">Delete</button>
        <button class="btn outline" onclick="exportData()">Export</button>
        <label class="btn outline cursor-pointer">Import<input type="file" accept="application/json" class="hidden" onchange="importData(event)"/></label>
      </div>
    </header>

    <!-- TOP TABS (customers / estimate / parts / labor / prefs / company)  -->
    <nav class="flex flex-wrap gap-2 mb-4 no-print">
      <button class="tab-btn" id="tab-customers" onclick="show('customers')">Customers</button>
      <button class="tab-btn active" id="tab-estimate" onclick="show('estimate')">Estimate</button>
      <button class="tab-btn" id="tab-parts" onclick="show('parts')">Parts & Materials</button>
      <button class="tab-btn" id="tab-labor" onclick="show('labor')">Labor</button>
      <button class="tab-btn" id="tab-photos" onclick="show('photos')">Photos</button>
      <button class="tab-btn" id="tab-prefs" onclick="show('prefs')">Preferences</button>
      <button class="tab-btn" id="tab-company" onclick="show('company')">My company</button>
    </nav>

    <!-- CUSTOMERS -->
    <section id="view-customers" class="panel p-4 hidden">
      <div class="gridish">
        <div class="col-span-12 md:col-span-6">
          <h3 class="font-semibold mb-2">Main address</h3>
          <div class="gridish">
            <div class="col-span-12"><input class="field" id="c_name" placeholder="Customer name" oninput="bindCustomer()"></div>
            <div class="col-span-12 md:col-span-6"><input class="field" id="c_contact" placeholder="Contact name" oninput="bindCustomer()"></div>
            <div class="col-span-12 md:col-span-6"><input class="field" id="c_email" placeholder="Email" oninput="bindCustomer()"></div>
            <div class="col-span-12 md:col-span-6"><input class="field" id="c_phone" placeholder="Phone" oninput="bindCustomer()"></div>
            <div class="col-span-12 md:col-span-6"><input class="field" id="c_fax" placeholder="Fax" oninput="bindCustomer()"></div>
            <div class="col-span-12"><input class="field" id="c_addr1" placeholder="Address 1" oninput="bindCustomer()"></div>
            <div class="col-span-12"><input class="field" id="c_addr2" placeholder="Address 2" oninput="bindCustomer()"></div>
            <div class="col-span-6"><input class="field" id="c_city" placeholder="City" oninput="bindCustomer()"></div>
            <div class="col-span-3"><input class="field" id="c_state" placeholder="State" oninput="bindCustomer()"></div>
            <div class="col-span-3"><input class="field" id="c_zip" placeholder="Postal / Zip" oninput="bindCustomer()"></div>
            <div class="col-span-12 mt-2"><button class="btn outline" onclick="copyToAlt()">Copy to alternate</button></div>
          </div>
        </div>
        <div class="col-span-12 md:col-span-6">
          <h3 class="font-semibold mb-2">Alternate address</h3>
          <div class="gridish">
            <div class="col-span-12 md:col-span-6"><input class="field" id="a_contact" placeholder="Contact name" oninput="bindCustomer()"></div>
            <div class="col-span-12 md:col-span-6"><input class="field" id="a_email" placeholder="Email" oninput="bindCustomer()"></div>
            <div class="col-span-12 md:col-span-6"><input class="field" id="a_phone" placeholder="Phone" oninput="bindCustomer()"></div>
            <div class="col-span-12"><input class="field" id="a_addr1" placeholder="Address 1" oninput="bindCustomer()"></div>
            <div class="col-span-12"><input class="field" id="a_addr2" placeholder="Address 2" oninput="bindCustomer()"></div>
            <div class="col-span-6"><input class="field" id="a_city" placeholder="City" oninput="bindCustomer()"></div>
            <div class="col-span-3"><input class="field" id="a_state" placeholder="State" oninput="bindCustomer()"></div>
            <div class="col-span-3"><input class="field" id="a_zip" placeholder="Postal / Zip" oninput="bindCustomer()"></div>
          </div>
        </div>
      </div>
      <div class="mt-4 flex gap-2 items-center">
        <button class="btn" onclick="saveCustomer()">Save customer</button>
        <span class="muted text-sm">Active only</span>
        <span class="pill">All</span>
      </div>
      <div class="mt-4">
        <h4 class="font-semibold mb-2">Customer list</h4>
        <table class="w-full list text-sm" id="customersTable">
          <thead><tr><th>Name</th><th>Contact</th><th>City</th><th class="text-right">Select</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ESTIMATE -->
    <section id="view-estimate" class="panel p-4">
      <div class="gridish mb-3">
        <div class="col-span-12 md:col-span-8">
          <div class="flex items-center gap-2">
            <input class="field" id="est_name" placeholder="Estimate description" oninput="bindEstimate()"/>
            <button class="btn outline" onclick="assignCustomer()">Assign customer</button>
          </div>
          <div class="text-sm muted mt-1" id="assignedCustomer">No customer assigned</div>
        </div>
        <div class="col-span-12 md:col-span-4 flex gap-2 justify-end no-print">
          <button class="btn" onclick="generatePDF('estimate')">Print estimate</button>
          <button class="btn" onclick="generatePDF('invoice')">Print invoice</button>
          <button class="btn orange" onclick="sharePDF('invoice')">Share invoice</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full list text-sm" id="itemsTable">
          <thead>
            <tr>
              <th>Type</th><th>Code/Desc</th><th class="text-right">Qty/Hrs</th><th class="text-right">Unit price</th><th class="text-right">Total</th><th class="text-right no-print">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="4" class="text-right">Subtotal</td><td id="t_sub" class="text-right font-semibold">$0.00</td><td></td></tr>
            <tr><td colspan="4" class="text-right">Markup (<span id="t_markup_rate">0</span>%)</td><td id="t_markup" class="text-right">$0.00</td><td></td></tr>
            <tr><td colspan="4" class="text-right">Tax (<span id="t_tax_rate">0</span>%)</td><td id="t_tax" class="text-right">$0.00</td><td></td></tr>
            <tr style="background:#e8e8e8; font-weight:bold;"><td colspan="4" class="text-right font-bold">Grand total</td><td id="t_total" class="text-right font-bold">$0.00</td><td></td></tr>
          </tfoot>
        </table>
      </div>

      <div class="mt-3 panel p-3">
        <div class="font-semibold mb-2">Add item</div>
        <div class="gridish items-end">
          <div class="col-span-12 md:col-span-2">
            <select id="add_type" class="field">
              <option value="part">Part</option>
              <option value="labor">Labor</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="col-span-12 md:col-span-3"><input id="add_code" class="field" placeholder="Code/Desc"></div>
          <div class="col-span-6 md:col-span-2"><input id="add_qty" class="field" type="number" step="0.01" placeholder="Qty/Hrs"></div>
          <div class="col-span-6 md:col-span-2"><input id="add_price" class="field" type="number" step="0.01" placeholder="Unit price"></div>
          <div class="col-span-12 md:col-span-2"><label class="inline-flex items-center gap-2"><input id="add_taxed" type="checkbox" class="accent-blue-600" checked/><span class="muted text-sm">Taxable</span></label></div>
          <div class="col-span-12 md:col-span-1"><button class="btn w-full" onclick="addItem()">Add</button></div>
        </div>
      </div>
    </section>

    <!-- PHOTOS PER PHASE -->
    <section id="view-photos" class="panel p-4 hidden">
      <div class="gridish items-end">
        <div class="col-span-12 md:col-span-4">
          <label class="block text-sm mb-1">Phase</label>
          <select id="photoPhase" class="field"></select>
        </div>
        <div class="col-span-12 md:col-span-6">
          <label class="btn outline cursor-pointer">Select photos<input type="file" multiple accept="image/*" class="hidden" onchange="handlePhotoFiles(event)"/></label>
        </div>
      </div>
      <div id="phasePhotosGrid" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3"></div>
    </section>

    <!-- PARTS & MATERIALS -->
    <section id="view-parts" class="panel p-4 hidden">
      <div class="gridish items-end">
        <div class="col-span-12 md:col-span-3"><input id="pm_code" class="field" placeholder="Code"></div>
        <div class="col-span-12 md:col-span-5"><input id="pm_desc" class="field" placeholder="Description"></div>
        <div class="col-span-6 md:col-span-2"><input id="pm_price" class="field" type="number" step="0.01" placeholder="Price per unit"></div>
        <div class="col-span-6 md:col-span-2"><button class="btn w-full" onclick="addPart()">Add</button></div>
      </div>
      <table class="w-full list text-sm mt-3" id="partsTable">
        <thead><tr><th>Code</th><th>Desc</th><th class="text-right">Price</th><th class="text-right no-print">Add to estimate</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- LABOR -->
    <section id="view-labor" class="panel p-4 hidden">
      <div class="gridish items-end">
        <div class="col-span-12 md:col-span-4"><input id="lb_desc" class="field" placeholder="Rate description (e.g., General labor)"></div>
        <div class="col-span-6 md:col-span-3"><input id="lb_rate" class="field" type="number" step="0.01" placeholder="Rate per hour"></div>
        <div class="col-span-6 md:col-span-2"><button class="btn w-full" onclick="addRate()">Add</button></div>
      </div>
      <table class="w-full list text-sm mt-3" id="laborTable">
        <thead><tr><th>Desc</th><th class="text-right">$/hr</th><th class="text-right no-print">Add to estimate</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- PREFS -->
    <section id="view-prefs" class="panel p-4 hidden">
      <div class="gridish">
        <div class="col-span-12 md:col-span-6">
          <h3 class="font-semibold mb-2">Tax & properties</h3>
          <div class="space-y-3">
            <label class="flex items-center gap-3"><span class="w-48">Tax rate (%)</span><input id="pf_tax" type="number" step="0.0001" class="field"/></label>
            <label class="flex items-center gap-3"><span class="w-48">Markup rate (%)</span><input id="pf_markup" type="number" step="0.0001" class="field"/></label>
            <label class="flex items-center gap-3"><span class="w-48">Include markup in tax</span><input id="pf_includeMarkupInTax" type="checkbox" class="accent-blue-600"/></label>
          </div>
        </div>
        <div class="col-span-12 md:col-span-6">
          <h3 class="font-semibold mb-2">Database</h3>
          <div class="space-y-2">
            <button class="btn outline" onclick="resetAll()">Empty database</button>
            <div class="muted text-xs">Data is stored locally in your browser (offline). Export regularly.</div>
          </div>
        </div>
      </div>
      <div class="mt-4"><button class="btn" onclick="savePrefs()">Save preferences</button></div>
    </section>

    <!-- COMPANY -->
    <section id="view-company" class="panel p-4 hidden">
      <div class="gridish">
        <div class="col-span-12 md:col-span-6">
          <h3 class="font-semibold mb-2">My company information</h3>
          <div class="gridish">
            <div class="col-span-12"><input id="co_name" class="field" placeholder="Company name"></div>
            <div class="col-span-6"><input id="co_contact" class="field" placeholder="Contact name"></div>
            <div class="col-span-6"><input id="co_email" class="field" placeholder="Email"></div>
            <div class="col-span-6"><input id="co_phone" class="field" placeholder="Phone"></div>
            <div class="col-span-6"><input id="co_web" class="field" placeholder="Web"></div>
            <div class="col-span-12"><input id="co_addr1" class="field" placeholder="Address 1"></div>
            <div class="col-span-12"><input id="co_addr2" class="field" placeholder="Address 2"></div>
            <div class="col-span-6"><input id="co_city" class="field" placeholder="City"></div>
            <div class="col-span-3"><input id="co_state" class="field" placeholder="State"></div>
            <div class="col-span-3"><input id="co_zip" class="field" placeholder="Postal / Zip"></div>
          </div>
        </div>
        <div class="col-span-12 md:col-span-6">
          <h3 class="font-semibold mb-2">Terms standard text</h3>
          <textarea id="co_terms" class="field" rows="10" placeholder="Payment terms, conditions, etc."></textarea>
          <div class="mt-3"><button class="btn" onclick="saveCompany()">Save company</button></div>
        </div>
      </div>
    </section>

    <!-- PRINT AREA -->
    <div id="print-area" class="hidden"></div>
  </div>

  <script>
    // ======= DATA MODEL =======
    const DB_KEY = 'offline_estimator_v1';
    const state = {
      company: { name:'', contact:'', email:'', phone:'', web:'', addr1:'', addr2:'', city:'', state:'', zip:'', terms:'' },
      prefs: { taxRate: 0, markupRate: 0, includeMarkupInTax: false },
      customers: [],
      parts: [], // {code, desc, price}
      laborRates: [], // {desc, rate}
      estimate: { name: '', customerId: null, items: [] } // items: {id, type, code, desc, qty, unit, price, taxed}
    };

    function load(){
      const raw = localStorage.getItem(DB_KEY);
      if(raw){ Object.assign(state, JSON.parse(raw)); }
      renderAll();
    }
    function persist(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); }

    // ======= NAV =======
    function show(key){
      document.querySelectorAll('[id^="view-"]').forEach(el=>el.classList.add('hidden'));
      document.getElementById(`view-${key}`).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(`tab-${key}`).classList.add('active');
    }

    // ======= CUSTOMERS =======
    function bindCustomer(){
      currentEditingCustomer = {
        name: document.getElementById('c_name').value,
        contact: document.getElementById('c_contact').value,
        email: document.getElementById('c_email').value,
        phone: document.getElementById('c_phone').value,
        fax: document.getElementById('c_fax').value,
        addr1: document.getElementById('c_addr1').value,
        addr2: document.getElementById('c_addr2').value,
        city: document.getElementById('c_city').value,
        state: document.getElementById('c_state').value,
        zip: document.getElementById('c_zip').value,
        alt: {
          contact: document.getElementById('a_contact').value,
          email: document.getElementById('a_email').value,
          phone: document.getElementById('a_phone').value,
          addr1: document.getElementById('a_addr1').value,
          addr2: document.getElementById('a_addr2').value,
          city: document.getElementById('a_city').value,
          state: document.getElementById('a_state').value,
          zip: document.getElementById('a_zip').value,
        }
      };
    }
    let currentEditingCustomer = {};
    function copyToAlt(){
      document.getElementById('a_contact').value = document.getElementById('c_contact').value;
      document.getElementById('a_email').value = document.getElementById('c_email').value;
      document.getElementById('a_phone').value = document.getElementById('c_phone').value;
      document.getElementById('a_addr1').value = document.getElementById('c_addr1').value;
      document.getElementById('a_addr2').value = document.getElementById('c_addr2').value;
      document.getElementById('a_city').value = document.getElementById('c_city').value;
      document.getElementById('a_state').value = document.getElementById('c_state').value;
      document.getElementById('a_zip').value = document.getElementById('c_zip').value;
      bindCustomer();
    }
    function saveCustomer(){
      bindCustomer();
      if(!currentEditingCustomer.name){ alert('Customer name required'); return; }
      const id = 'c_' + Date.now();
      state.customers.push({ id, ...currentEditingCustomer });
      currentEditingCustomer = {};
      persist();
      renderCustomers();
    }
    function renderCustomers(){
      const tbody = document.querySelector('#customersTable tbody');
      tbody.innerHTML = state.customers.map(c=>`
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td>${escapeHtml(c.contact||'')}</td>
          <td>${escapeHtml(c.city||'')}</td>
          <td class="text-right"><button class="btn outline" onclick="selectCustomer('${c.id}')">Select</button></td>
        </tr>
      `).join('');
    }
    function selectCustomer(id){ state.estimate.customerId = id; persist(); renderEstimateHeader(); show('estimate'); }

    // ======= PARTS =======
    function addPart(){
      const code = document.getElementById('pm_code').value.trim();
      const desc = document.getElementById('pm_desc').value.trim();
      const price = parseFloat(document.getElementById('pm_price').value||'0');
      if(!code || !desc){ alert('Code and description required'); return; }
      state.parts.push({ code, desc, price });
      persist();
      renderParts();
      document.getElementById('pm_code').value='';
      document.getElementById('pm_desc').value='';
      document.getElementById('pm_price').value='';
    }
    function renderParts(){
      const tbody = document.querySelector('#partsTable tbody');
      tbody.innerHTML = state.parts.map(p=>`
        <tr>
          <td>${escapeHtml(p.code)}</td>
          <td>${escapeHtml(p.desc)}</td>
          <td class="text-right">${fmt(p.price)}</td>
          <td class="text-right no-print"><button class="btn outline" onclick="quickAddPart('${encodeURIComponent(p.code)}')">Add</button></td>
        </tr>
      `).join('');
    }
    function quickAddPart(codeEnc){
      const code = decodeURIComponent(codeEnc);
      const p = state.parts.find(x=>x.code===code); if(!p) return;
      state.estimate.items.push({ id: uid(), type:'part', code:p.code, desc:p.desc, qty:1, price:p.price, taxed:true });
      persist();
      renderItems();
      show('estimate');
    }

    // ======= LABOR =======
    function addRate(){
      const desc = document.getElementById('lb_desc').value.trim();
      const rate = parseFloat(document.getElementById('lb_rate').value||'0');
      if(!desc){ alert('Description required'); return; }
      state.laborRates.push({ desc, rate });
      persist();
      renderLabor();
      document.getElementById('lb_desc').value='';
      document.getElementById('lb_rate').value='';
    }
    function renderLabor(){
      const tbody = document.querySelector('#laborTable tbody');
      tbody.innerHTML = state.laborRates.map(r=>`
        <tr>
          <td>${escapeHtml(r.desc)}</td>
          <td class="text-right">${fmt(r.rate)}</td>
          <td class="text-right no-print"><button class="btn outline" onclick="quickAddLabor('${encodeURIComponent(r.desc)}')">Add</button></td>
        </tr>
      `).join('');
    }
    function quickAddLabor(descEnc){
      const desc = decodeURIComponent(descEnc);
      const r = state.laborRates.find(x=>x.desc===desc); if(!r) return;
      state.estimate.items.push({ id: uid(), type:'labor', code:'', desc:r.desc, qty:1, price:r.rate, taxed:false });
      persist();
      renderItems();
      show('estimate');
    }

    // ======= ESTIMATE =======
    function bindEstimate(){ state.estimate.name = document.getElementById('est_name').value; persist(); renderEstimateHeader(); }
    function assignCustomer(){ show('customers'); }
    function renderEstimateHeader(){
      document.getElementById('hdrEstimateName').textContent = state.estimate.name || 'New estimate';
      const c = state.customers.find(x=>x.id===state.estimate.customerId);
      document.getElementById('assignedCustomer').textContent = c ? `${c.name} — ${c.city||''}` : 'No customer assigned';
    }
    function addItem(){
      const type = document.getElementById('add_type').value;
      const code = document.getElementById('add_code').value.trim();
      const qty = parseFloat(document.getElementById('add_qty').value||'0');
      const price = parseFloat(document.getElementById('add_price').value||'0');
      const taxed = document.getElementById('add_taxed').checked;
      const desc = code; // minimal for now
      if(!code){ alert('Enter a description or code'); return; }
      state.estimate.items.push({ id: uid(), type, code, desc, qty, price, taxed });
      persist();
      renderItems();
      document.getElementById('add_code').value='';
      document.getElementById('add_qty').value='';
      document.getElementById('add_price').value='';
    }
    function removeItem(id){ state.estimate.items = state.estimate.items.filter(i=>i.id!==id); persist(); renderItems(); }
    function renderItems(){
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML = state.estimate.items.map(i=>{
        const total = (i.qty||0) * (i.price||0);
        return `<tr>
          <td class="uppercase">${i.type}</td>
          <td>${escapeHtml(i.desc)}</td>
          <td class="text-right"><input type="number" step="0.01" value="${i.qty}" class="field w-24" onchange="editItem('${i.id}','qty',this.value)"></td>
          <td class="text-right"><input type="number" step="0.01" value="${i.price}" class="field w-28" onchange="editItem('${i.id}','price',this.value)"></td>
          <td class="text-right">${fmt(total)}</td>
          <td class="text-right no-print">
            <label class="text-xs mr-2"><input type="checkbox" ${i.taxed?'checked':''} onchange="editItem('${i.id}','taxed',this.checked)"> Tax</label>
            <button class="btn red" onclick="removeItem('${i.id}')">Delete</button>
          </td>
        </tr>`;
      }).join('');
      // totals
      const sub = state.estimate.items.reduce((s,i)=>s+((i.qty||0)*(i.price||0)),0);
      const markup = sub * ((state.prefs.markupRate||0)/100);
      const taxBase = state.prefs.includeMarkupInTax ? sub + markup : sub;
      const tax = (state.estimate.items.filter(i=>i.taxed).reduce((s,i)=>s+((i.qty||0)*(i.price||0)),0) ? (taxBase * ((state.prefs.taxRate||0)/100)) : 0);
      const total = sub + markup + tax;
      document.getElementById('t_sub').textContent = fmt(sub);
      document.getElementById('t_markup').textContent = fmt(markup);
      document.getElementById('t_tax').textContent = fmt(tax);
      document.getElementById('t_total').textContent = fmt(total);
      document.getElementById('t_tax_rate').textContent = (state.prefs.taxRate||0).toFixed(2);
      document.getElementById('t_markup_rate').textContent = (state.prefs.markupRate||0).toFixed(2);
    }
    function editItem(id,key,val){
      const it = state.estimate.items.find(x=>x.id===id); if(!it) return;
      if(key==='qty' || key==='price'){ it[key] = parseFloat(val)||0; }
      else if(key==='taxed'){ it.taxed = !!val; }
      persist(); renderItems();
    }

    // ======= PREFS & COMPANY =======
    function savePrefs(){
      state.prefs.taxRate = parseFloat(document.getElementById('pf_tax').value||'0');
      state.prefs.markupRate = parseFloat(document.getElementById('pf_markup').value||'0');
      state.prefs.includeMarkupInTax = document.getElementById('pf_includeMarkupInTax').checked;
      persist(); renderItems();
    }
    function saveCompany(){
      state.company = {
        name: g('co_name'), contact: g('co_contact'), email:g('co_email'), phone:g('co_phone'), web:g('co_web'),
        addr1:g('co_addr1'), addr2:g('co_addr2'), city:g('co_city'), state:g('co_state'), zip:g('co_zip'), terms:g('co_terms')
      };
      persist();
    }

    // ======= EXPORT / IMPORT =======
    function exportData(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'estimator-data.json'; a.click(); URL.revokeObjectURL(url);
    }
    function importData(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => { Object.assign(state, JSON.parse(reader.result)); persist(); renderAll(); };
      reader.readAsText(file);
    }
    function resetAll(){ if(confirm('Erase all local data?')){ localStorage.removeItem(DB_KEY); location.reload(); } }

    // ======= PRINT (ESTIMATE / INVOICE) =======
    function generatePDF(kind){
      const c = state.customers.find(x=>x.id===state.estimate.customerId) || {};
      const area = document.getElementById('print-area');
      const itemsRows = state.estimate.items.map(i=>`<tr><td>${i.type}</td><td>${escapeHtml(i.desc)}</td><td style="text-align:right">${num(i.qty)}</td><td style="text-align:right">${fmt(i.price)}</td><td style="text-align:right">${fmt((i.qty||0)*(i.price||0))}</td></tr>`).join('');
      const sub = state.estimate.items.reduce((s,i)=>s+((i.qty||0)*(i.price||0)),0);
      const markup = sub * ((state.prefs.markupRate||0)/100);
      const taxBase = state.prefs.includeMarkupInTax ? sub + markup : sub;
      const tax = state.estimate.items.some(i=>i.taxed) ? taxBase * ((state.prefs.taxRate||0)/100) : 0;
      const total = sub + markup + tax;

      area.innerHTML = `
        <div style="font-family:Inter,Arial; width:8.5in; padding:0.6in; color:#111">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px">
            <div>
              <div style="font-size:22px; font-weight:700">${escapeHtml(state.company.name||'Company')}</div>
              <div style="font-size:12px">${esc(state.company.addr1)} ${esc(state.company.addr2)} ${esc(state.company.city)} ${esc(state.company.state)} ${esc(state.company.zip)}</div>
              <div style="font-size:12px">${esc(state.company.phone)} ${esc(state.company.email)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:26px; font-weight:800">${kind==='invoice'?'INVOICE':'ESTIMATE'}</div>
              <div>${new Date().toLocaleDateString()}</div>
            </div>
          </div>
          <hr/>
          <div style="display:flex; gap:30px; margin:14px 0">
            <div style="flex:1">
              <div style="font-weight:700">Bill to</div>
              <div>${esc(c.name)}</div>
              <div>${esc(c.addr1)} ${esc(c.addr2)}</div>
              <div>${esc(c.city)} ${esc(c.state)} ${esc(c.zip)}</div>
              <div>${esc(c.phone)} ${esc(c.email)}</div>
            </div>
            <div style="flex:1"></div>
          </div>
          <table style="width:100%; border-collapse:collapse; font-size:13px">
            <thead>
              <tr style="background:#f3f4f6"><th style="text-align:left; padding:6px; border:1px solid #e5e7eb">Type</th><th style="text-align:left; padding:6px; border:1px solid #e5e7eb">Description</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Qty/Hrs</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Unit</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Total</th></tr>
            </thead>
            <tbody>${itemsRows||'<tr><td colspan="5" style="padding:8px; text-align:center">No items</td></tr>'}</tbody>
            <tfoot>
              <tr><td colspan="4" style="text-align:right; padding:6px; border:1px solid #e5e7eb">Subtotal</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(sub)}</td></tr>
              <tr><td colspan="4" style="text-align:right; padding:6px; border:1px solid #e5e7eb">Markup (${(state.prefs.markupRate||0).toFixed(2)}%)</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(markup)}</td></tr>
              <tr><td colspan="4" style="text-align:right; padding:6px; border:1px solid #e5e7eb">Tax (${(state.prefs.taxRate||0).toFixed(2)}%)</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(tax)}</td></tr>
              <tr><td colspan="4" style="text-align:right; padding:10px; border:1px solid #e5e7eb; font-weight:800">Total</td><td style="text-align:right; padding:10px; border:1px solid #e5e7eb; font-weight:800">${fmt(total)}</td></tr>
            </tfoot>
          </table>
          ${state.company.terms ? `<div style="margin-top:18px; font-size:12px"><strong>Terms</strong><br>${escapeHtml(state.company.terms)}</div>`:''}
        </div>`;

      const opt = { margin: 0, filename: `${kind}-${Date.now()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
      html2pdf().from(area).set(opt).save();
    }

    // ======= UTIL =======
    function renderAll(){
      // fill prefs
      document.getElementById('pf_tax').value = state.prefs.taxRate;
      document.getElementById('pf_markup').value = state.prefs.markupRate;
      document.getElementById('pf_includeMarkupInTax').checked = !!state.prefs.includeMarkupInTax;
      // company
      setVal('co_name', state.company.name); setVal('co_contact', state.company.contact); setVal('co_email', state.company.email); setVal('co_phone', state.company.phone); setVal('co_web', state.company.web);
      setVal('co_addr1', state.company.addr1); setVal('co_addr2', state.company.addr2); setVal('co_city', state.company.city); setVal('co_state', state.company.state); setVal('co_zip', state.company.zip); setVal('co_terms', state.company.terms);
      // lists
      renderCustomers(); renderParts(); renderLabor(); renderEstimateHeader(); renderItems();
    }
    function g(id){ return document.getElementById(id).value; }
    function setVal(id, v){ document.getElementById(id).value = v||''; }
    function uid(){ return Math.random().toString(36).slice(2) }
    function fmt(n){ n = Number(n||0); return n.toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function num(n){ return Number(n||0).toFixed(2) }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    const esc = escapeHtml;

    // ======= NEW ESTIMATE =======
    function newEstimate(){ state.estimate = { name:'', customerId:null, items:[] }; persist(); renderAll(); show('estimate'); }

    window.addEventListener('load', load);
  </script>

  <!-- Phase-enabled extensions -->
  <script>
    // ===== PHASE LAYER (non-breaking: items gain a 'phase' tag and UI adds phase tabs) =====
    let currentPhase = null;

    // Initialize default phases if absent
    const DEFAULT_PHASES = ['Kitchen','Living Addition','Existing Remodel','Other'];

    function ensurePhases(){
      if(!state.estimate.phases || !Array.isArray(state.estimate.phases) || state.estimate.phases.length===0){
        state.estimate.phases = [...DEFAULT_PHASES];
        currentPhase = state.estimate.phases[0];
        persist();
      }
      if(!currentPhase){ currentPhase = state.estimate.phases[0]; }
    }

    // Inject Phase UI inside Estimate view header
    function mountPhaseUI(){
      ensurePhases();
      const view = document.getElementById('view-estimate');
      if(!view) return;
      let bar = document.getElementById('phase-bar');
      if(!bar){
        bar = document.createElement('div');
        bar.id = 'phase-bar';
        bar.className = 'no-print mb-3 flex flex-wrap gap-2';
        view.insertBefore(bar, view.children[1]);
      }
      bar.innerHTML = '';
      state.estimate.phases.forEach(p=>{
        const btn = document.createElement('button');
        btn.className = 'tab-btn' + (p===currentPhase?' active':'');
        btn.textContent = p;
        btn.onclick = ()=>{ currentPhase = p; renderItems(); mountPhaseUI(); };
        bar.appendChild(btn);
      });
      const addBtn = document.createElement('button');
      addBtn.className = 'tab-btn';
      addBtn.textContent = '+ Phase';
      addBtn.onclick = ()=>{
        const name = prompt('New phase name');
        if(!name) return;
        if(!state.estimate.phases.includes(name)){
          state.estimate.phases.push(name);
          currentPhase = name;
          persist();
          renderItems();
          mountPhaseUI();
        }
      };
      bar.appendChild(addBtn);
    }

    // Override addItem to tag with current phase
    const _addItem = addItem;
    addItem = function(){
      ensurePhases();
      const prevCount = state.estimate.items.length;
      _addItem();
      // last pushed gets tagged
      const it = state.estimate.items[state.estimate.items.length-1];
      if(state.estimate.items.length>prevCount && it){ it.phase = currentPhase; persist(); renderItems(); }
    }

    // Helper to compute totals per phase and globally
    function computeTotals(){
      const totals = { phases:{}, global:{ sub:0, markup:0, tax:0, total:0 } };
      const subByPhase = {};
      state.estimate.items.forEach(i=>{
        const ph = i.phase || 'Unassigned';
        const line = (i.qty||0)*(i.price||0);
        subByPhase[ph] = (subByPhase[ph]||0) + line;
      });
      const subGlobal = Object.values(subByPhase).reduce((a,b)=>a+b,0);
      const markupGlobal = subGlobal * ((state.prefs.markupRate||0)/100);
      const taxBase = state.prefs.includeMarkupInTax ? subGlobal + markupGlobal : subGlobal;
      const anyTaxable = state.estimate.items.some(i=>i.taxed);
      const taxGlobal = anyTaxable ? taxBase * ((state.prefs.taxRate||0)/100) : 0;
      totals.global = { sub: subGlobal, markup: markupGlobal, tax: taxGlobal, total: subGlobal+markupGlobal+taxGlobal };
      Object.keys(subByPhase).forEach(ph=>{
        const sub = subByPhase[ph];
        const mk = sub * ((state.prefs.markupRate||0)/100);
        const tb = state.prefs.includeMarkupInTax ? sub + mk : sub;
        const hasTaxable = state.estimate.items.some(i=> (i.phase||'Unassigned')===ph && i.taxed );
        const tx = hasTaxable ? tb * ((state.prefs.taxRate||0)/100) : 0;
        totals.phases[ph] = { sub, markup: mk, tax: tx, total: sub+mk+tx };
      });
      return totals;
    }

    // Override renderItems to filter by phase and show phase + master totals
    const _renderItems = renderItems;
    renderItems = function(){
      ensurePhases();
      // Filter table rows by current phase
      const tbody = document.querySelector('#itemsTable tbody');
      if(!tbody) return;
      const items = state.estimate.items.filter(i => (i.phase||currentPhase) === currentPhase);
      tbody.innerHTML = items.map(i=>{
        const total = (i.qty||0)*(i.price||0);
        return `<tr>
          <td class="uppercase">${i.type}</td>
          <td>${escapeHtml(i.desc||i.code||'')}</td>
          <td class="text-right"><input type="number" step="0.01" value="${i.qty||0}" class="field w-24" onchange="editItem('${i.id}','qty',this.value)"></td>
          <td class="text-right"><input type="number" step="0.01" value="${i.price||0}" class="field w-28" onchange="editItem('${i.id}','price',this.value)"></td>
          <td class="text-right">${fmt(total)}</td>
          <td class="text-right no-print">
            <label class="text-xs mr-2"><input type="checkbox" ${i.taxed?'checked':''} onchange="editItem('${i.id}','taxed',this.checked)"> Tax</label>
            <button class="btn red" onclick="removeItem('${i.id}')">Delete</button>
          </td>
        </tr>`;
      }).join('');

      // Recompute totals
      const totals = computeTotals();

      // Phase footer
      document.getElementById('t_sub').textContent = fmt(totals.phases[currentPhase]?.sub||0);
      document.getElementById('t_markup').textContent = fmt(totals.phases[currentPhase]?.markup||0);
      document.getElementById('t_tax').textContent = fmt(totals.phases[currentPhase]?.tax||0);
      document.getElementById('t_total').textContent = fmt(totals.phases[currentPhase]?.total||0);
      document.getElementById('t_tax_rate').textContent = (state.prefs.taxRate||0).toFixed(2);
      document.getElementById('t_markup_rate').textContent = (state.prefs.markupRate||0).toFixed(2);

      // Add or update master totals box below table
      let box = document.getElementById('masterTotals');
      if(!box){
        box = document.createElement('div');
        box.id = 'masterTotals';
        box.className = 'mt-4 panel p-4';
        document.getElementById('view-estimate').appendChild(box);
      }
      const rows = Object.entries(totals.phases).map(([ph,v])=>`<tr><td>${escapeHtml(ph)}</td><td style="text-align:right">${fmt(v.sub)}</td><td style="text-align:right">${fmt(v.markup)}</td><td style="text-align:right">${fmt(v.tax)}</td><td style="text-align:right">${fmt(v.total)}</td></tr>`).join('');
      box.innerHTML = `
        <div class="font-semibold mb-2">Master estimate totals (auto-updating)</div>
        <div class="overflow-x-auto"><table class="w-full list text-sm">
          <thead><tr><th>Phase</th><th class="text-right">Subtotal</th><th class="text-right">Markup</th><th class="text-right">Tax</th><th class="text-right">Total</th></tr></thead>
          <tbody>${rows||'<tr><td colspan="5" class="text-center p-2">No items</td></tr>'}</tbody>
          <tfoot><tr style="background:#e8e8e8; font-weight:bold;"><td class="font-bold">Grand total</td><td class="text-right">${fmt(totals.global.sub)}</td><td class="text-right">${fmt(totals.global.markup)}</td><td class="text-right">${fmt(totals.global.tax)}</td><td class="text-right font-bold">${fmt(totals.global.total)}</td></tr></tfoot>
        </table></div>`;

      // Refresh phase bar to reflect active state
      mountPhaseUI();
    }

    // Extend PDF to group by phase
    const _generatePDF = generatePDF;
    generatePDF = function(kind){
      ensurePhases();
      const byPhase = {};
      state.estimate.items.forEach(i=>{
        const ph = i.phase || 'Unassigned';
        byPhase[ph] = byPhase[ph]||[]; byPhase[ph].push(i);
      });
      const area = document.getElementById('print-area');
      const totals = computeTotals();
      const sections = Object.keys(byPhase).sort().map(ph=>{
        const rows = byPhase[ph].map(i=>`<tr><td>${i.type}</td><td>${escapeHtml(i.desc)}</td><td style="text-align:right">${num(i.qty)}</td><td style="text-align:right">${fmt(i.price)}</td><td style="text-align:right">${fmt((i.qty||0)*(i.price||0))}</td></tr>`).join('');
        const t = totals.phases[ph];
        return `<h3 style="margin:18px 0 8px 0">${escapeHtml(ph)}</h3>
          <table style="width:100%; border-collapse:collapse; font-size:13px">
            <thead><tr style="background:#f3f4f6"><th style="text-align:left; padding:6px; border:1px solid #e5e7eb">Type</th><th style="text-align:left; padding:6px; border:1px solid #e5e7eb">Description</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Qty/Hrs</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Unit</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Total</th></tr></thead>
            <tbody>${rows}</tbody>
            <tfoot><tr><td colspan="4" style="text-align:right; padding:6px; border:1px solid #e5e7eb">Phase total</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(t.total)}</td></tr></tfoot>
          </table>`;
      }).join('');

      // Use original to construct header/footer, then inject sections and master table at the content spot
      const c = state.customers.find(x=>x.id===state.estimate.customerId) || {};
      area.innerHTML = `
        <div style="font-family:Inter,Arial; width:8.5in; padding:0.6in; color:#111">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px">
            <div>
              <div style="font-size:22px; font-weight:700">${escapeHtml(state.company.name||'Company')}</div>
              <div style="font-size:12px">${esc(state.company.addr1)} ${esc(state.company.addr2)} ${esc(state.company.city)} ${esc(state.company.state)} ${esc(state.company.zip)}</div>
              <div style="font-size:12px">${esc(state.company.phone)} ${esc(state.company.email)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:26px; font-weight:800">${kind==='invoice'?'INVOICE':'ESTIMATE'}</div>
              <div>${new Date().toLocaleDateString()}</div>
            </div>
          </div>
          <hr/>
          <div style="display:flex; gap:30px; margin:14px 0">
            <div style="flex:1">
              <div style="font-weight:700">Bill to</div>
              <div>${esc(c.name)}</div>
              <div>${esc(c.addr1)} ${esc(c.addr2)}</div>
              <div>${esc(c.city)} ${esc(c.state)} ${esc(c.zip)}</div>
              <div>${esc(c.phone)} ${esc(c.email)}</div>
            </div>
            <div style="flex:1"></div>
          </div>
          ${sections}
          <h3 style="margin:18px 0 8px 0">Master totals</h3>
          <table style="width:100%; border-collapse:collapse; font-size:13px">
            <thead><tr style="background:#f3f4f6"><th style="text-align:left; padding:6px; border:1px solid #e5e7eb">Phase</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Subtotal</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Markup</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Tax</th><th style="text-align:right; padding:6px; border:1px solid #e5e7eb">Total</th></tr></thead>
            <tbody>
              ${Object.entries(totals.phases).map(([ph,v])=>`<tr><td style="padding:6px; border:1px solid #e5e7eb">${escapeHtml(ph)}</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(v.sub)}</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(v.markup)}</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(v.tax)}</td><td style="text-align:right; padding:6px; border:1px solid #e5e7eb">${fmt(v.total)}</td></tr>`).join('')}
            </tbody>
            <tfoot><tr><td style="padding:10px; border:1px solid #e5e7eb; font-weight:800">Grand total</td><td colspan="4" style="text-align:right; padding:10px; border:1px solid #e5e7eb; font-weight:800">${fmt(totals.global.total)}</td></tr></tfoot>
          </table>
          ${state.company.terms ? `<div style=\"margin-top:18px; font-size:12px\"><strong>Terms</strong><br>${escapeHtml(state.company.terms)}</div>`:''}
        </div>`;
      const opt = { margin: 0, filename: `${kind}-${Date.now()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
      html2pdf().from(area).set(opt).save();
    }

    // Hook phase UI on load and after renders
    const _renderAll = renderAll;
    renderAll = function(){ _renderAll(); mountPhaseUI(); };

    // Tag existing items as current phase if old data
    window.addEventListener('load', ()=>{
      ensurePhases();
      // backfill legacy items
      state.estimate.items.forEach(i=>{ if(!('phase' in i)) i.phase = currentPhase; });
      persist();
      mountPhaseUI();
      renderItems();
    });
  </script>


  <!-- Project store + photos + homeowner PDF tweaks -->
  <script>
    // ===== Multi-project wrapper =====
    const STORE_KEY = 'offline_estimator_projects_v1';
    let projectStore = { projects: [], activeId: null };

    function projectSnapshot(){
      // capture current single-project state into a snapshot
      return JSON.parse(JSON.stringify(state));
    }
    function applySnapshot(snap){
      // replace current working state with snapshot
      Object.keys(state).forEach(k=> delete state[k]);
      Object.assign(state, JSON.parse(JSON.stringify(snap)));
    }
    function loadStore(){
      const raw = localStorage.getItem(STORE_KEY);
      if(raw){ projectStore = JSON.parse(raw); }
      // migrate from old single-project if needed
      if(projectStore.projects.length===0){
        const old = localStorage.getItem(DB_KEY);
        if(old){
          // wrap existing into a project
          const snap = JSON.parse(old);
          const id = 'p_'+Date.now();
          projectStore.projects.push({ id, name: snap.estimate?.name || 'Project 1', data: snap });
          projectStore.activeId = id;
          localStorage.removeItem(DB_KEY);
        } else {
          const id = 'p_'+Date.now();
          projectStore.projects.push({ id, name: 'Project 1', data: JSON.parse(JSON.stringify(state)) });
          projectStore.activeId = id;
        }
        persistStore();
      }
    }
    function persistStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(projectStore)); }

    // Override load/persist to route through store
    const _origLoad = load;
    load = function(){
      _origLoad(); // loads legacy (no-op after migration), renders UI structures
      loadStore();
      const active = projectStore.projects.find(p=>p.id===projectStore.activeId) || projectStore.projects[0];
      applySnapshot(active.data);
      renderAll();
      populateProjectSelect();
    }
    const _origPersist = persist;
    persist = function(){
      _origPersist();
      const idx = projectStore.projects.findIndex(p=>p.id===projectStore.activeId);
      if(idx>-1){ projectStore.projects[idx].data = projectSnapshot(); }
      persistStore();
      populateProjectSelect();
    }

    function populateProjectSelect(){
      const sel = document.getElementById('projectSelect'); if(!sel) return;
      sel.innerHTML = projectStore.projects.map(p=>`<option value="${p.id}" ${p.id===projectStore.activeId?'selected':''}>${escapeHtml(p.name||'Untitled')}</option>`).join('');
    }
    function projectSwitch(id){
      const target = projectStore.projects.find(p=>p.id===id); if(!target) return;
      projectStore.activeId = id; persistStore();
      applySnapshot(target.data); renderAll();
    }
    function projectNew(){
      const id = 'p_'+Date.now();
      const snap = JSON.parse(JSON.stringify({ company: state.company, prefs: state.prefs, customers: [], parts: [], laborRates: [], estimate: { name:'', customerId:null, items: [], phases: ['Phase 1'], photos:{} } }));
      projectStore.projects.push({ id, name: 'New project', data: snap });
      projectStore.activeId = id; persistStore(); applySnapshot(snap); renderAll();
    }
    function projectDuplicate(){
      const active = projectStore.projects.find(p=>p.id===projectStore.activeId); if(!active) return;
      const id = 'p_'+Date.now();
      projectStore.projects.push({ id, name: (active.name||'Project')+' copy', data: projectSnapshot() });
      projectStore.activeId = id; persistStore(); populateProjectSelect();
    }
    function projectDelete(){
      if(projectStore.projects.length<=1){ alert('Keep at least one project.'); return; }
      if(!confirm('Delete current project?')) return;
      projectStore.projects = projectStore.projects.filter(p=>p.id!==projectStore.activeId);
      projectStore.activeId = projectStore.projects[0].id; persistStore();
      applySnapshot(projectStore.projects[0].data); renderAll();
    }

    // Export/Import now handle the entire store
    exportData = function(){
      const blob = new Blob([JSON.stringify(projectStore,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href=url; a.download='offline-estimator-projects.json'; a.click(); URL.revokeObjectURL(url);
    }
    importData = function(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{ projectStore = JSON.parse(reader.result); persistStore(); projectSwitch(projectStore.activeId||projectStore.projects[0].id); };
      reader.readAsText(file);
    }

    // ===== Photos per phase =====
    function ensurePhotos(){ if(!state.estimate.photos) state.estimate.photos = {}; }
    function handlePhotoFiles(ev){
      ensurePhotos(); ensurePhases();
      const phase = document.getElementById('photoPhase').value || currentPhase;
      const files = Array.from(ev.target.files||[]);
      if(!state.estimate.photos[phase]) state.estimate.photos[phase] = [];
      Promise.all(files.map(resizeImageUniform)).then(datas=>{
        datas.forEach(d=> state.estimate.photos[phase].push({ img:d, ts:Date.now() }));
        persist(); renderPhotos(); ev.target.value='';
      });
    }
    function resizeImageUniform(file){
      return new Promise((resolve)=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e=>{ img.src = e.target.result; };
        img.onload = ()=>{
          const canvas = document.createElement('canvas');
          const W=800, H=600; // uniform box
          canvas.width=W; canvas.height=H; const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);
          // contain fit
          const scale = Math.min(W/img.width, H/img.height);
          const nw = img.width*scale, nh = img.height*scale;
          const nx = (W-nw)/2, ny=(H-nh)/2;
          ctx.drawImage(img, nx, ny, nw, nh);
          resolve(canvas.toDataURL('image/jpeg',0.9));
        };
        reader.readAsDataURL(file);
      });
    }
    function renderPhotos(){
      ensurePhotos(); ensurePhases();
      const sel = document.getElementById('photoPhase'); if(!sel) return;
      sel.innerHTML = state.estimate.phases.map(p=>`<option value="${p}" ${p===currentPhase?'selected':''}>${escapeHtml(p)}</option>`).join('');
      const phase = sel.value || currentPhase;
      const grid = document.getElementById('phasePhotosGrid'); if(!grid) return;
      const items = (state.estimate.photos[phase]||[]);
      grid.innerHTML = items.map((ph,idx)=>`<div class="relative group"><img src="${ph.img}" class="w-full h-36 object-cover rounded border"/><button class="hidden group-hover:block absolute top-1 right-1 btn red text-xs" onclick="deletePhoto('${phase}',${idx})">Delete</button></div>`).join('');
    }
    function deletePhoto(phase, idx){ if(!confirm('Delete photo?')) return; state.estimate.photos[phase].splice(idx,1); persist(); renderPhotos(); }

    // Hook photos into nav show()
    const _show = show;
    show = function(key){ _show(key); if(key==='photos'){ renderPhotos(); } }

    // Update renderAll to refresh photos select
    const _ra = renderAll; renderAll = function(){ _ra(); renderPhotos(); populateProjectSelect(); };

    // ===== PDF for homeowner: per-phase totals + task list only + photos =====
    const _gen = generatePDF; // previous override exists; we replace again for the homeowner-friendly version
    generatePDF = function(kind){
      ensurePhases(); ensurePhotos();
      const byPhase = {};
      state.estimate.items.forEach(i=>{ const ph=i.phase||'Unassigned'; (byPhase[ph]=byPhase[ph]||[]).push(i); });
      const totals = computeTotals();
      const c = state.customers.find(x=>x.id===state.estimate.customerId) || {};
      const area = document.getElementById('print-area');
      const sections = Object.keys(byPhase).sort().map(ph=>{
        const list = byPhase[ph].map(i=>`<li>${escapeHtml(i.desc||i.code||'')}</li>`).join('');
        const photos = (state.estimate.photos[ph]||[]).map(p=>`<img src="${p.img}" style="width:1.9in;height:1.4in;object-fit:cover;border:1px solid #e5e7eb;border-radius:6px;margin:4px"/>`).join('');
        const t = totals.phases[ph];
        return `<div style="margin-top:14px">
          <div style="font-weight:700; font-size:15px; margin:6px 0">${escapeHtml(ph)} — ${fmt(t.total)}</div>
          <ul style="margin:0 0 6px 18px; padding:0; font-size:12px">${list||'<li>No items</li>'}</ul>
          ${photos?`<div style="display:flex; flex-wrap:wrap">${photos}</div>`:''}
        </div>`;
      }).join('');

      area.innerHTML = `
        <div style="font-family:Inter,Arial; width:8.5in; padding:0.6in; color:#111">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px">
            <div>
              <div style="font-size:22px; font-weight:700">${escapeHtml(state.company.name||'Company')}</div>
              <div style="font-size:12px">${esc(state.company.addr1)} ${esc(state.company.addr2)} ${esc(state.company.city)} ${esc(state.company.state)} ${esc(state.company.zip)}</div>
              <div style="font-size:12px">${esc(state.company.phone)} ${esc(state.company.email)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:26px; font-weight:800">${kind==='invoice'?'INVOICE':'ESTIMATE'}</div>
              <div>${new Date().toLocaleDateString()}</div>
            </div>
          </div>
          <hr/>
          <div style="display:flex; gap:30px; margin:14px 0">
            <div style="flex:1">
              <div style="font-weight:700">Bill to</div>
              <div>${esc(c.name)}</div>
              <div>${esc(c.addr1)} ${esc(c.addr2)}</div>
              <div>${esc(c.city)} ${esc(c.state)} ${esc(c.zip)}</div>
              <div>${esc(c.phone)} ${esc(c.email)}</div>
            </div>
            <div style="flex:1; text-align:right; font-size:14px">
              <div><strong>Project</strong>: ${escapeHtml(state.estimate.name||'')}</div>
            </div>
          </div>
          ${sections}
          <div style="margin-top:16px; font-size:16px; font-weight:800; text-align:right">Grand total: ${fmt(totals.global.total)}</div>
          ${state.company.terms ? `<div style=\"margin-top:18px; font-size:12px\"><strong>Terms</strong><br>${escapeHtml(state.company.terms)}</div>`:''}
        </div>`;
      const opt = { margin: 0, filename: `${kind}-${Date.now()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
      html2pdf().from(area).set(opt).save();
    }

    // ===== SHARE PDF VIA WEB SHARE API (SMS, Email, etc.) =====
    async function sharePDF(kind){
      ensurePhases(); ensurePhotos();
      const byPhase = {};
      state.estimate.items.forEach(i=>{ const ph=i.phase||'Unassigned'; (byPhase[ph]=byPhase[ph]||[]).push(i); });
      const totals = computeTotals();
      const c = state.customers.find(x=>x.id===state.estimate.customerId) || {};
      const area = document.getElementById('print-area');
      const sections = Object.keys(byPhase).sort().map(ph=>{
        const list = byPhase[ph].map(i=>`<li>${escapeHtml(i.desc||i.code||'')}</li>`).join('');
        const photos = (state.estimate.photos[ph]||[]).map(p=>`<img src="${p.img}" style="width:1.9in;height:1.4in;object-fit:cover;border:1px solid #e5e7eb;border-radius:6px;margin:4px"/>`).join('');
        const t = totals.phases[ph];
        return `<div style="margin-top:14px">
          <div style="font-weight:700; font-size:15px; margin:6px 0">${escapeHtml(ph)} — ${fmt(t.total)}</div>
          <ul style="margin:0 0 6px 18px; padding:0; font-size:12px">${list||'<li>No items</li>'}</ul>
          ${photos?`<div style="display:flex; flex-wrap:wrap">${photos}</div>`:''}
        </div>`;
      }).join('');

      area.innerHTML = `
        <div style="font-family:Inter,Arial; width:8.5in; padding:0.6in; color:#111">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px">
            <div>
              <div style="font-size:22px; font-weight:700">${escapeHtml(state.company.name||'Company')}</div>
              <div style="font-size:12px">${esc(state.company.addr1)} ${esc(state.company.addr2)} ${esc(state.company.city)} ${esc(state.company.state)} ${esc(state.company.zip)}</div>
              <div style="font-size:12px">${esc(state.company.phone)} ${esc(state.company.email)}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:26px; font-weight:800">${kind==='invoice'?'INVOICE':'ESTIMATE'}</div>
              <div>${new Date().toLocaleDateString()}</div>
            </div>
          </div>
          <hr/>
          <div style="display:flex; gap:30px; margin:14px 0">
            <div style="flex:1">
              <div style="font-weight:700">Bill to</div>
              <div>${esc(c.name)}</div>
              <div>${esc(c.addr1)} ${esc(c.addr2)}</div>
              <div>${esc(c.city)} ${esc(c.state)} ${esc(c.zip)}</div>
              <div>${esc(c.phone)} ${esc(c.email)}</div>
            </div>
            <div style="flex:1; text-align:right; font-size:14px">
              <div><strong>Project</strong>: ${escapeHtml(state.estimate.name||'')}</div>
            </div>
          </div>
          ${sections}
          <div style="margin-top:16px; font-size:16px; font-weight:800; text-align:right">Grand total: ${fmt(totals.global.total)}</div>
          ${state.company.terms ? `<div style=\"margin-top:18px; font-size:12px\"><strong>Terms</strong><br>${escapeHtml(state.company.terms)}</div>`:''}
        </div>`;

      try {
        // Generate PDF as blob
        const opt = {
          margin: 0,
          filename: `${kind}-${c.name||'client'}-${Date.now()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        const pdfBlob = await html2pdf().from(area).set(opt).outputPdf('blob');
        const fileName = `${kind}-${c.name||'client'}-${Date.now()}.pdf`;
        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

        // Check if Web Share API is supported
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: `${kind.charAt(0).toUpperCase() + kind.slice(1)} for ${c.name||'Client'}`,
            text: `${kind.charAt(0).toUpperCase() + kind.slice(1)} from ${state.company.name||'Owensboro Mowing Company'}`,
            files: [file]
          });
          console.log('PDF shared successfully');
        } else {
          // Fallback: Just download the PDF
          alert('Sharing not supported on this device. The PDF will be downloaded instead.');
          html2pdf().from(area).set(opt).save();
        }
      } catch (error) {
        console.error('Error sharing PDF:', error);
        alert('Error sharing PDF. The file will be downloaded instead.');
        const opt = { margin: 0, filename: `${kind}-${Date.now()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
        html2pdf().from(area).set(opt).save();
      }
    }

    // ===== REGISTER SERVICE WORKER FOR PWA =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }

    // ===== PWA INSTALL PROMPT =====
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPrompt();
    });

    function showInstallPrompt() {
      // Create install banner if not already exists
      if (document.getElementById('install-banner')) return;

      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#2A9D8F; color:white; padding:15px 25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:9999; display:flex; gap:15px; align-items:center; max-width:90%; animation:slideUp 0.3s ease;';
      banner.innerHTML = `
        <span style="flex:1;">Install this app for offline access!</span>
        <button onclick="installPWA()" style="background:white; color:#2A9D8F; border:none; padding:8px 16px; border-radius:6px; font-weight:600; cursor:pointer;">Install</button>
        <button onclick="dismissInstallPrompt()" style="background:transparent; color:white; border:1px solid white; padding:8px 16px; border-radius:6px; cursor:pointer;">Later</button>
      `;
      document.body.appendChild(banner);
    }

    function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        }
        deferredPrompt = null;
        dismissInstallPrompt();
      });
    }

    function dismissInstallPrompt() {
      const banner = document.getElementById('install-banner');
      if (banner) banner.remove();
    }

    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      dismissInstallPrompt();
    });

  </script>
</body>
</html>
